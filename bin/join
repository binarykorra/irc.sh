#!/usr/bin/env bash

SHIRCDIR="$(dirname $0)/../io"

CHAN="$1"
PROPERCHAN="${CHAN//%/#}"

echo "JOIN $PROPERCHAN" >> "$SHIRCDIR/cmd.in"

rm -f "$SHIRCDIR/$CHAN.in"
mkfifo "$SHIRCDIR/$CHAN.in"
(cat <> "$SHIRCDIR/$CHAN.in" & echo $! >&3) 3>>"$SHIRCDIR/$CHAN.pid" | sed -l "s/^/PRIVMSG $PROPERCHAN : /" >> "$SHIRCDIR/cmd.in" &

(tail -f "$SHIRCDIR/main.out" & echo $! >&3) 3>>"$SHIRCDIR/$CHAN.pid" | grep --line-buffered "PRIVMSG $PROPERCHAN" | sed -lE 's/:([^!]+)![^:]+:(.+)/<\1> \2/' >> "$SHIRCDIR/$CHAN.out" &
